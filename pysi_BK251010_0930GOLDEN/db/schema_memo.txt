#schema_memo.txt

schema.sql（最小スキーマ一式）
-- 推奨 PRAGMA（接続直後に毎回）
PRAGMA journal_mode=WAL;
PRAGMA synchronous=NORMAL;
PRAGMA foreign_keys=ON;

-- 1) シナリオ
CREATE TABLE IF NOT EXISTS scenario (
  id            INTEGER PRIMARY KEY AUTOINCREMENT,
  name          TEXT NOT NULL UNIQUE,
  plan_year_st  INTEGER NOT NULL,
  plan_range    INTEGER NOT NULL,
  created_at    TEXT NOT NULL DEFAULT (datetime('now'))
);

-- 2) ノード / 製品（最小プロファイル）
CREATE TABLE IF NOT EXISTS node (
  id         INTEGER PRIMARY KEY AUTOINCREMENT,
  name       TEXT NOT NULL UNIQUE,
  longitude  REAL,
  latitude   REAL
);

CREATE TABLE IF NOT EXISTS product (
  id    INTEGER PRIMARY KEY AUTOINCREMENT,
  name  TEXT NOT NULL UNIQUE
);

-- 3) ノード×製品の計画パラメータ（SKU的プロファイル）
CREATE TABLE IF NOT EXISTS node_product (
  node_id    INTEGER NOT NULL,
  product_id INTEGER NOT NULL,
  lot_size   INTEGER NOT NULL DEFAULT 1,    -- 需要→ロット化の最小単位
  leadtime   INTEGER NOT NULL DEFAULT 0,    -- 週
  ss_days    INTEGER NOT NULL DEFAULT 0,    -- 安全在庫（日）
  long_vacation_weeks TEXT,                 -- 例: '[1,2,15]'
  PRIMARY KEY (node_id, product_id),
  FOREIGN KEY (node_id)    REFERENCES node(id)    ON DELETE CASCADE,
  FOREIGN KEY (product_id) REFERENCES product(id) ON DELETE CASCADE
);

-- 4) 月次ステージング（そのまま投げ込む入れ物）
CREATE TABLE IF NOT EXISTS monthly_demand_stg (
  scenario_id INTEGER NOT NULL,
  node_id     INTEGER NOT NULL,
  product_id  INTEGER NOT NULL,
  year        INTEGER NOT NULL,
  m1 REAL DEFAULT 0,  m2 REAL DEFAULT 0,  m3 REAL DEFAULT 0,
  m4 REAL DEFAULT 0,  m5 REAL DEFAULT 0,  m6 REAL DEFAULT 0,
  m7 REAL DEFAULT 0,  m8 REAL DEFAULT 0,  m9 REAL DEFAULT 0,
  m10 REAL DEFAULT 0, m11 REAL DEFAULT 0, m12 REAL DEFAULT 0,
  UNIQUE (scenario_id, node_id, product_id, year),
  FOREIGN KEY (scenario_id) REFERENCES scenario(id) ON DELETE CASCADE,
  FOREIGN KEY (node_id)     REFERENCES node(id)     ON DELETE CASCADE,
  FOREIGN KEY (product_id)  REFERENCES product(id)  ON DELETE CASCADE
);

-- 5) 週次需要（集計後の正規化テーブル）
CREATE TABLE IF NOT EXISTS weekly_demand (
  scenario_id INTEGER NOT NULL,
  node_id     INTEGER NOT NULL,
  product_id  INTEGER NOT NULL,
  iso_year    INTEGER NOT NULL,
  iso_week    INTEGER NOT NULL,                     -- 1..53
  value       REAL    NOT NULL DEFAULT 0,           -- 週合計数量（単位は元データ）
  UNIQUE (scenario_id, node_id, product_id, iso_year, iso_week),
  FOREIGN KEY (scenario_id) REFERENCES scenario(id) ON DELETE CASCADE,
  FOREIGN KEY (node_id)     REFERENCES node(id)     ON DELETE CASCADE,
  FOREIGN KEY (product_id)  REFERENCES product(id)  ON DELETE CASCADE
);
CREATE INDEX IF NOT EXISTS idx_weekly_qry
  ON weekly_demand (scenario_id, node_id, product_id, iso_year, iso_week);

-- 6) 生成された lot（週単位で 0001 リセット）
CREATE TABLE IF NOT EXISTS lot (
  scenario_id INTEGER NOT NULL,
  node_id     INTEGER NOT NULL,
  product_id  INTEGER NOT NULL,
  iso_year    INTEGER NOT NULL,
  iso_week    INTEGER NOT NULL,
  lot_id      TEXT    NOT NULL,                     -- 形式: NODE-PROD-YYYYWWNNNN
  -- デフォルトは lot_id 全体で一意（人が見た時に衝突しない運用）
  UNIQUE (lot_id),
  FOREIGN KEY (scenario_id) REFERENCES scenario(id) ON DELETE CASCADE,
  FOREIGN KEY (node_id)     REFERENCES node(id)     ON DELETE CASCADE,
  FOREIGN KEY (product_id)  REFERENCES product(id)  ON DELETE CASCADE
);
CREATE INDEX IF NOT EXISTS idx_lot_lookup
  ON lot (scenario_id, node_id, product_id, iso_year, iso_week);

-- ※ シナリオ間で同じ lot_id を許容したい場合は上の UNIQUE を
--    UNIQUE (scenario_id, lot_id) に変更してください。

-- 7) エンジン出力（各週×バケツに lot を配置）
CREATE TABLE IF NOT EXISTS lot_bucket (
  scenario_id INTEGER NOT NULL,
  layer  TEXT NOT NULL CHECK(layer IN ('demand','supply')),
  node_id     INTEGER NOT NULL,
  product_id  INTEGER NOT NULL,
  week_index  INTEGER NOT NULL,                      -- calendar_iso.week_index
  bucket TEXT NOT NULL CHECK(bucket IN ('S','CO','I','P')),
  lot_id  TEXT  NOT NULL,
  UNIQUE (scenario_id, layer, node_id, product_id, week_index, bucket, lot_id),
  FOREIGN KEY (scenario_id) REFERENCES scenario(id) ON DELETE CASCADE,
  FOREIGN KEY (node_id)     REFERENCES node(id)     ON DELETE CASCADE,
  FOREIGN KEY (product_id)  REFERENCES product(id)  ON DELETE CASCADE
);
CREATE INDEX IF NOT EXISTS idx_lot_bucket_qry
  ON lot_bucket (scenario_id, layer, node_id, product_id, week_index, bucket);

-- 8) 参照カレンダ（Step1で作成済み）:
-- calendar_iso(week_index PK, iso_year, iso_week, week_start, week_end, UNIQUE(iso_year, iso_week))
-- ここでは再作成しない

運用メモ（超要点）

lot_id の仕様は NODE-PRODUCT-YYYYWWNNNN（週ごとに 0001 からリセット）。

冪等：全テーブル UNIQUE を付け、INSERT は INSERT OR REPLACE / ON CONFLICT DO NOTHING で再実行安全に。

問合せの主キーは scenario_id, node_id, product_id, (iso_year, iso_week) または week_index（calendar_iso 経由）。

lot_bucket はエンジンの“真実の在り処”（S/CO/I/P へ lot を置く）。ビューや可視化はここを参照。
